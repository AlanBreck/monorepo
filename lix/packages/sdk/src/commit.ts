import { Kysely } from "kysely"
import type { LixDatabase } from "./schema.js"
import { v4 } from "uuid"

export async function commit(args: {
	db: Kysely<LixDatabase>
	userId: string
	description: string
}) {
	return args.db.transaction().execute(async (trx) => {
		const commit = await trx
			.insertInto("commit")
			.values({
				id: v4(),
				user_id: args.userId,
				// todo - use zoned datetime
				zoned_date_time: new Date().toISOString(),
				description: args.description,
			})
			.returning("id")
			.executeTakeFirstOrThrow()

		return await trx
			.updateTable("change")
			.where("commit_id", "is", undefined)
			.set({
				commit_id: commit.id,
			})
			.execute()
	})
}
