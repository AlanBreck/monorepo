name: Sync Examples

on:
  push:
    # Trigger if an example CHANGELOG is changed on main -> usually after a release
    branches:
      - "main"
    paths:
      - "**/example/CHANGELOG.md"
      - "**/examples/*/CHANGELOG.md"
  # TODO REMOVE - ONLY FOR TESTING
  pull_request:
    branches:
      - "main"
  workflow_dispatch:

#
# The jobs should do a few things:
# 1. Check out the repository
# 2. Set up pnpm
# 3. Run `pnpm pack` in the /inlang/source-code/paraglide/paraglide-js/example directory
# 4. Unpack the generated tarball 
# 5. Commit the unpacked tarball to https://github.com/lorissigrist/paraglide-js-example
# 6. Force Push the commit to the repository

jobs:
  sync-examples:
    strategy:
      matrix:
        path:
          - ./inlang/source-code/paraglide/paraglide-js-adapter-sveltekit/example
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
     
      - name: Setup Pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install node
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.version }}
          cache: "pnpm"

      - name: Create Lockfile
        run: pnpm install --lockfile-only

      - name: Pack
        run: pnpm pack --pack-destination ./tmp 
        working-directory: ${{ matrix.path }}

      - name: Unpack
        # The tarball contains a package/ directory
        # This will create a ./package
        run: tar -xvf ./tmp/*.tgz
        working-directory: ${{ matrix.path }}

      - name: log
        run: ls -la
        working-directory: ${{ matrix.path }}